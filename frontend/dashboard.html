<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - TC Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <link rel="icon" href="assets/logo.png">
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar p-3 text-white">
      <div class="mb-4 text-center">
        <img src="assets/logo.png" alt="logo" width="60" class="mb-2">
        <div><strong>TC Panel</strong></div>
      </div>
      <hr>
      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link active">
            <i class="bi bi-speedometer2 me-2"></i> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a href="buses.html" class="nav-link">
            <i class="bi bi-bus-front me-2"></i> Buses
          </a>
        </li>
        <li class="nav-item">
          <a href="routes.html" class="nav-link">
            <i class="bi bi-map me-2"></i> Routes
          </a>
        </li>
        <li class="nav-item">
          <a href="assignments.html" class="nav-link">
            <i class="bi bi-calendar-check me-2"></i> Assignments
          </a>
        </li>
        <li class="nav-item">
          <a href="settings.html" class="nav-link">
            <i class="bi bi-gear me-2"></i> Settings
          </a>
        </li>
      </ul>
      <hr>
      <div class="dropdown">
        <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-person-circle me-2"></i>
          <strong id="username-display">Admin</strong>
        </a>
        <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
          <li><a class="dropdown-item" href="settings.html">Settings</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" id="logout-btn">Sign out</a></li>
        </ul>
      </div>
    </div>

    <!-- Main content -->
    <div class="main-content flex-grow-1">
      <div class="topbar d-flex justify-content-between align-items-center">
        <h4>Dashboard</h4>
        <div>
          <span id="current-date"></span>
        </div>
      </div>

      <div class="alert-container"></div>

      <div class="row g-4 mb-4" id="stats-container">
        <div class="col-md-4">
          <div class="p-3 glass">
            <h6>Buses</h6>
            <h2 id="buses-count">0</h2>
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-3 glass">
            <h6>Routes</h6>
            <h2 id="routes-count">0</h2>
          </div>
        </div>
        <div class="col-md-4">
          <div class="p-3 glass">
            <h6>Assignments</h6>
            <h2 id="assignments-count">0</h2>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="glass p-3">
            <h5 class="mb-3">Recent Assignments</h5>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Vehicle Number</th>
                    <th>Route</th>
                    <th>Date</th>
                    <th>Departure Time</th>
                  </tr>
                </thead>
                <tbody id="recent-assignments">
                  <!-- Assignments will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"></script>
  <script src="js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Display current date
      const currentDateEl = document.getElementById('current-date');
      if (currentDateEl) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        currentDateEl.textContent = new Date().toLocaleDateString(undefined, options);
      }

      // Load dashboard data
      try {
        // Get buses count
        const busesResult = await api.get('/buses');
        if (busesResult.success) {
          document.getElementById('buses-count').textContent = busesResult.data.length;
        }

        // Get routes count
        const routesResult = await api.get('/routes');
        if (routesResult.success) {
          document.getElementById('routes-count').textContent = routesResult.data.length;
        }

        // Get assignments count and recent assignments
        const assignmentsResult = await api.get('/assignments');
        if (assignmentsResult.success) {
          document.getElementById('assignments-count').textContent = assignmentsResult.data.length;

          // Display recent assignments (up to 5)
          const recentAssignmentsEl = document.getElementById('recent-assignments');
          const recentAssignments = assignmentsResult.data.slice(0, 5);

          if (recentAssignments.length > 0) {
            recentAssignmentsEl.innerHTML = recentAssignments.map(assignment => `
              <tr>
                <td>${assignment.vehicleNumber}</td>
                <td>${assignment.route ? assignment.route.routeName : 'N/A'}</td>
                <td>${ui.formatDate(assignment.assignDate)}</td>
                <td>${ui.formatTime(assignment.departureTime)}</td>
              </tr>
            `).join('');
          } else {
            recentAssignmentsEl.innerHTML = '<tr><td colspan="4" class="text-center">No recent assignments</td></tr>';
          }
        }
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        ui.showAlert('Error loading dashboard data');
      }
    });
  </script>
</body>
</html>